# Overall guidance for setup of deployment files

# Subscription guidance

1. 1 subcription for all regions for resource fetcher
2. 1 subcription per partner for all regions for partner resources

# File usage guidance

## Service model, rollout files

- Separate service model and rollout files for infrastructure and application deployment. These are generated code items. Do not manually edit.
- **Infra**
  - one file that deploys both partner and resource fetcher resources
  - same file deploys subscription level and region level resources for both the workloads.
    - resource fetcher regional level
    - resource fetcher subscription level - execution constraint for a single region run
    - partner regional level
    - partner fetcher subscription level - execution constraint for a single region run
  - stamps(ev2 term) are used to increase number of partners in every region i.e. 1 stamp is used for 1 partner. The same can also be used to increase resource fetcher workloads per region.
- **Application**
  - Content for application specific rollout specs come from centralized content that is copied\formatted to meet the list of partners\applications. Do not manually edit those rollout specs.
  - [see below](#application-deployment-guidance)
  -

## Configuration specification file

- Global settings object will be used for values that are constant across regions or independent of regions.
- Aim to design to pass in one object instead of multiple small string configs.
- Region level settings are used for resource fetcher workload settings, expected to be modified only by Datalabs team.
- Stamp level settings are used for partner workload settings, expected to be modified by partner.
- (Future) this file is a good candidate to be autogenerated.

# Application deployment guidance

- Sample example to deploy AKS apps via region agnostic model : https://msazure.visualstudio.com/Azure-Express/_git/Samples?path=/ServiceGroupRoot_Buildout_AppDeploy&version=GBmaster
- Ev2 sample with example for deploying AKS apps - https://ev2docs.azure.net/features/application/intro.html (**The sample explanation is _NOT_ using region agnostic model for deployment. Please use for reference of the process only.**

# ADO integration for infra and application rollouts

- Both should be run from the ADO release pipelines and use Ev2 guidance.
- Refer https://ev2docs.azure.net/getting-started/production/build-pipeline.html?tabs=tabid-1. The following steps are required to run releases from ADO pipeline.
  - Register service artifacts
  - Register subscriptions
  - StageMap
  - Register presence
  - Update ADO release definition
  - Monitor and operate rollout

# Scenarios and file changes expected

## Additional partner requirement

1. Update configuration specification file - add a new stamp and create a new "partner" object, fill in all the values.
2. Extensibility - if new partner needs certain resources for eg: cosmos (that is not used in the workload until now)
   1. Add new resourcetype template per resource type or grouping under "Common" templates(if not already there).
   2. Partner resource template should add the new resource deployment.
   3. Partner resource parameters should add the new parameters.
   4. Configuration specification file and scope bindings should be updated for the appropriate stamp for getting configuration from the "partner" object. Aim to design to pass in one object instead of multiple small string configs.

## Additional resource fetcher requirements

1. If resource fetcher needs certain resources for eg: cosmos (that is not used in the workload until now)
   1. Add new resourcetype template per resource type or grouping under "Common" templates(if not already there).
   2. Resource fetcher template should add the new resource deployment.
   3. Resource fetcher parameters should add the new parameters.
   4. Configuration specification file and scope bindings should be updated for the appropriate stamp for getting configuration from the "resourceFetcher" object. Aim to design to pass in one object instead of multiple small string configs.

## Cloud expansion

1. Creating new config spec with updated copies of all values.
